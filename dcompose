#!/usr/bin/env node
"use strict";

var fs          = require('fs'),
    path        = require('path'),
    optimist    = require('optimist')
      .usage('Usage: dcompose [options] entry')
      .check(function(argv) {
        if (argv._.length === 0) throw new Error('provide entry');
      })
      .option('h', {
        alias: 'help',
        boolean: true,
        describe: 'Show this message and exit'
      })
      .option('t', {
        alias: 'transform',
        describe: 'Apply transform'
      })
      .option('d', {
        alias: 'debug',
        describe: 'Emit source maps'
      })
      .option('o', {
        alias: 'output',
        describe: 'Set output directory'
      })
      .option('multi', {
        boolean: true,
        describe: 'Split bundle into multiple pieces'
      })
      .option('js', {
        boolean: true,
        describe: 'Process only JavaScript'
      })
      .option('css', {
        boolean: true,
        describe: 'Process only CSS'
      });

var argv = optimist.argv;

if (argv.help)
  return optimist.showHelp();

if (!argv.multi)
  var DCompose = require('./index')
else
  var DCompose = require('./multi/index');

var composer = new DCompose({
  entries: argv._,
  transform: [].concat(argv.t).concat(argv.transform).filter(Boolean),
  extensions: [].concat(argv.extension).filter(Boolean)
});

var output = argv.output || argv.o || '.';

function onError(stream) {
  stream.on('error', function(err) {
    console.error(err.stack);
    process.exit(1);
  });
  return stream;
}

function layoutMultiBundle(streams, directory) {
  for (var name in streams)
    streams[name]
      .pipe(fs.createWriteStream(path.join(directory, name)))
}

if (argv.multi) {
  layoutMultiBundle(composer.all(argv), output);
} else if (argv.js) {
  onError(composer.js(argv)).pipe(output === '-'
    ?  process.stdout
    : fs.createWriteStream(path.join(output, 'bundle.js')));

} else if (argv.css) {
  onError(composer.css(argv)).pipe(output === '-'
    ?  process.stdout
    : fs.createWriteStream(path.join(output, 'bundle.css')));

} else {
  var bundles = composer.all(argv);
  ['js', 'css'].forEach(function(bundle) {
    onError(bundles[bundle]).pipe(
      fs.createWriteStream(path.join(output, 'bundle.' + bundle)));
  });
}

